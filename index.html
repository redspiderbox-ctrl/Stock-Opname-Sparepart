<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Opname Sparepart</title>

<!-- LIBRARY -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root{
--primary:#2563eb;--bg:#f1f5f9;--card:#fff;
--success:#16a34a;--danger:#dc2626;--neutral:#64748b;
--border:#e5e7eb;
}
body{margin:0;font-family:Segoe UI;background:var(--bg)}
header{background:#fff;padding:16px 24px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.container{padding:20px}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 25px rgba(0,0,0,.05)}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
input,button{
padding:10px 14px;border-radius:10px;border:1px solid var(--border);
font-size:14px
}
button.primary{background:var(--primary);color:#fff;border:none}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--border);font-size:14px}
th{background:#f8fafc;text-align:left}
.selih{font-weight:600;text-align:center;border-radius:8px}
.plus{background:#dcfce7;color:var(--success)}
.minus{background:#fee2e2;color:var(--danger)}
.zero{background:#f1f5f9;color:var(--neutral)}
input[type=number]{width:70px}
#reader{width:100%;max-width:320px;margin-top:10px}
</style>
</head>

<body>

<header>
<h2>ðŸ“¦ Stock Opname Sparepart</h2>
</header>

<div class="container">
<div class="card">

<div class="controls">
<input type="date" id="tanggal">
<input type="file" id="fileInput" accept=".xlsx">
<input type="text" id="search" placeholder="Cari Part / Deskripsi" oninput="filterTable()">
<button onclick="startScan()">ðŸ“· Scan</button>
<button class="primary" onclick="exportExcel()">â¬‡ Excel</button>
<button class="primary" onclick="exportPDF()">â¬‡ PDF</button>
</div>

<div id="reader"></div>

<table>
<thead>
<tr>
<th>No</th><th>Part</th><th>Deskripsi</th>
<th>Qty</th><th>Fisik</th><th>Selisih</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>
</div>

<script>
const tbody=document.getElementById("tbody");
const storageKey="opnameData";

/* ===== LOAD STORAGE ===== */
window.onload=()=>{
document.getElementById("tanggal").value=
localStorage.getItem("tanggal") || new Date().toISOString().split("T")[0];
loadStorage();
}

/* ===== EXCEL ===== */
document.getElementById("fileInput").addEventListener("change",e=>{
const r=new FileReader();
r.onload=ev=>{
const wb=XLSX.read(new Uint8Array(ev.target.result),{type:"array"});
const sh=wb.Sheets[wb.SheetNames[0]];
const rows=XLSX.utils.sheet_to_json(sh,{header:1});
tbody.innerHTML="";
rows.slice(1).forEach((r,i)=>addRow(i+1,r[1],r[2],r[3],0));
saveStorage();
}
r.readAsArrayBuffer(e.target.files[0]);
});

/* ===== ADD ROW ===== */
function addRow(no,part,desc,qty,fisik){
const tr=document.createElement("tr");
tr.innerHTML=`
<td>${no}</td>
<td>${part}</td>
<td>${desc}</td>
<td class="qty">${qty}</td>
<td><input type="number" value="${fisik}" oninput="calc(this)"></td>
<td class="selih zero">0</td>`;
tbody.appendChild(tr);
calc(tr.querySelector("input"));
}

/* ===== HITUNG ===== */
function calc(i){
const r=i.closest("tr");
const q=parseInt(r.querySelector(".qty").innerText)||0;
const f=parseInt(i.value)||0;
const s=f-q;
const c=r.querySelector(".selih");
c.innerText=s;
c.className="selih "+(s>0?"plus":s<0?"minus":"zero");
saveStorage();
}

/* ===== SEARCH ===== */
function filterTable(){
const k=document.getElementById("search").value.toLowerCase();
tbody.querySelectorAll("tr").forEach(r=>{
r.style.display=
r.cells[1].innerText.toLowerCase().includes(k)||
r.cells[2].innerText.toLowerCase().includes(k)?"":"none";
});
}

/* ===== SCAN BARCODE / QR ===== */
function startScan(){
const qr=new Html5Qrcode("reader");
qr.start(
{ facingMode: "environment" },
{ fps: 10, qrbox: 250 },
txt=>{
document.getElementById("search").value=txt;
filterTable();
qr.stop();
}
);
}

/* ===== STORAGE ===== */
function saveStorage(){
const data=[];
tbody.querySelectorAll("tr").forEach(r=>{
data.push({
part:r.cells[1].innerText,
desc:r.cells[2].innerText,
qty:r.cells[3].innerText,
fisik:r.cells[4].querySelector("input").value
});
});
localStorage.setItem(storageKey,JSON.stringify(data));
localStorage.setItem("tanggal",document.getElementById("tanggal").value);
}

function loadStorage(){
const data=JSON.parse(localStorage.getItem(storageKey)||"[]");
tbody.innerHTML="";
data.forEach((d,i)=>addRow(i+1,d.part,d.desc,d.qty,d.fisik));
}

/* ===== EXPORT EXCEL ===== */
function exportExcel(){
const data=[["Tanggal",document.getElementById("tanggal").value]];
data.push(["No","Part","Deskripsi","Qty","Fisik","Selisih"]);
tbody.querySelectorAll("tr").forEach(r=>{
data.push([
r.cells[0].innerText,
r.cells[1].innerText,
r.cells[2].innerText,
r.cells[3].innerText,
r.cells[4].querySelector("input").value,
r.cells[5].innerText
]);
});
const ws=XLSX.utils.aoa_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Opname");
XLSX.writeFile(wb,"stock-opname.xlsx");
}

/* ===== EXPORT PDF ===== */
function exportPDF(){
const { jsPDF } = window.jspdf;
const doc=new jsPDF();
doc.text("Stock Opname Sparepart",14,14);
doc.text("Tanggal : "+document.getElementById("tanggal").value,14,22);
const rows=[];
tbody.querySelectorAll("tr").forEach(r=>{
rows.push([
r.cells[0].innerText,
r.cells[1].innerText,
r.cells[2].innerText,
r.cells[3].innerText,
r.cells[4].querySelector("input").value,
r.cells[5].innerText
]);
});
doc.autoTable({
startY:26,
head:[["No","Part","Deskripsi","Qty","Fisik","Selisih"]],
body:rows,
styles:{fontSize:8}
});
doc.save("stock-opname.pdf");
}
</script>

</body>
</html>
